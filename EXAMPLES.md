# Examples

## Simple `void` function example

```csharp
// <auto-generated at 2020-11-27T12:36:10.6501599+01:00 />
using System;
using System.Linq;
using System.Collections.Generic;
using System.Threading.Tasks;
using Norm.Extensions;
using NpgsqlTypes;
using Npgsql;

namespace PgRoutiner.Test
{
    public static class PgRoutineMyFunction
    {
        public const string Name = "close_case";

        /// <summary>
        /// sql function "my_function"
        /// some comment
        /// </summary>
        public static void MyFunction(this NpgsqlConnection connection, long? userId, long? otherParam)
        {
            connection
                .AsProcedure()
                .Execute(Name, ("_user_id", userId, NpgsqlDbType.Bigint), ("_other_param", otherParam, NpgsqlDbType.Bigint));
        }

        /// <summary>
        /// sql function "my_function"
        /// some comment
        /// </summary>
        public static async ValueTask MyFunctionAsync(this NpgsqlConnection connection, long? userId, long? otherParam)
        {
            await connection
                .AsProcedure()
                .ExecuteAsync(Name, ("_user_id", userId, NpgsqlDbType.Bigint), ("_other_param", otherParam, NpgsqlDbType.Bigint));
        }
    }
}

```

### Usage

- You may use following function as normal connection object extension, and you'll have full static type checking and IDE support:

```csharp
using var connection = new NpgsqlConnection(connectionString);
await connection.MyFunctionAsync(1, 2);
```

## Function that returns a single value with overload example

```csharp
// <auto-generated at 2020-11-27T12:36:10.6374735+01:00 />
using System;
using System.Linq;
using System.Collections.Generic;
using System.Threading.Tasks;
using Norm.Extensions;
using NpgsqlTypes;
using Npgsql;

namespace PgRoutiner.Test
{
    public static class PgRoutineAddUserToRole
    {
        public const string Name = "add_user_to_role";

        /// <summary>
        /// plpgsql function "add_user_to_role"
        /// </summary>
        public static bool? AddUserToRole(this NpgsqlConnection connection, string userName, string roleName)
        {
            return connection
                .AsProcedure()
                .Single<bool?>(Name, ("_user_name", userName, NpgsqlDbType.Varchar), ("_role_name", roleName, NpgsqlDbType.Varchar));
        }

        /// <summary>
        /// plpgsql function "add_user_to_role"
        /// </summary>
        public static async ValueTask<bool?> AddUserToRoleAsync(this NpgsqlConnection connection, string userName, string roleName)
        {
            return await connection
                .AsProcedure()
                .SingleAsync<bool?>(Name, ("_user_name", userName, NpgsqlDbType.Varchar), ("_role_name", roleName, NpgsqlDbType.Varchar));
        }

        /// <summary>
        /// sql function "add_user_to_role"
        /// add user to user_role by user id and role name
        /// </summary>
        public static void AddUserToRole(this NpgsqlConnection connection, long? userId, string normalizedRoleName)
        {
            connection
                .AsProcedure()
                .Execute(Name, ("_user_id", userId, NpgsqlDbType.Bigint), ("_normalized_role_name", normalizedRoleName, NpgsqlDbType.Varchar));
        }

        /// <summary>
        /// sql function "add_user_to_role"
        /// add user to user_role by user id and role name
        /// </summary>
        public static async ValueTask AddUserToRoleAsync(this NpgsqlConnection connection, long? userId, string normalizedRoleName)
        {
            await connection
                .AsProcedure()
                .ExecuteAsync(Name, ("_user_id", userId, NpgsqlDbType.Bigint), ("_normalized_role_name", normalizedRoleName, NpgsqlDbType.Varchar));
        }
    }
}
```

## Function returning anonymous table

PostgreSQL functions can return record set, for example:

```sql
create or replace function get_answers(_user_id bigint) returns table (
    key varchar,
    question text,
    answered boolean
)
as
-- rest of the function definition
```

Generated code for this function will look like this:

```csharp
// <auto-generated at 2020-11-27T12:36:10.7434889+01:00 />
using System;
using System.Linq;
using System.Collections.Generic;
using System.Threading.Tasks;
using Norm.Extensions;
using NpgsqlTypes;
using Npgsql;

namespace PgRoutiner.Test
{
    public class GetAnswersResult
    {
        public string Key { get; set; }
        public string Question { get; set; }
        public bool? Answered { get; set; }
    }

    public static class PgRoutineGetAnswers
    {
        public const string Name = "get_answers";

        /// <summary>
        /// sql function "get_answers"
        /// get answers for user
        /// </summary>
        public static IEnumerable<GetAnswersResult> GetAnswers(this NpgsqlConnection connection, long? userId)
        {
            return connection
                .AsProcedure()
                .Read<string, string, bool?>(Name, ("_user_id", userId, NpgsqlDbType.Bigint))
                .Select(tuple => new GetAnswersResult
                {
                    Key = tuple.Item1,
                    Question = tuple.Item2,
                    Answered = tuple.Item3
                });
        }

        /// <summary>
        /// sql function "get_answers"
        /// get answers for user
        /// </summary>
        public static IAsyncEnumerable<GetAnswersResult> GetAnswersAsync(this NpgsqlConnection connection, long? userId)
        {
            return  connection
                .AsProcedure()
                .ReadAsync<string, string, bool?>(Name, ("_user_id", userId, NpgsqlDbType.Bigint))
                .Select(tuple => new GetAnswersResult
                {
                    Key = tuple.Item1,
                    Question = tuple.Item2,
                    Answered = tuple.Item3
                });
        }
    }
}
```

## Returning existing table


PostgreSQL can return existing table. These functions will also produce similar code:

```csharp
// <auto-generated at 2020-11-27T12:36:10.7168899+01:00 />
using System;
using System.Linq;
using System.Collections.Generic;
using System.Threading.Tasks;
using Norm.Extensions;
using NpgsqlTypes;
using Npgsql;

namespace PgRoutiner.Test
{
    public class User
    {
        public long Id { get; set; }
        public string UserName { get; set; }
        public string NormalizedUserName { get; set; }
        public string Email { get; set; }
        public string NormalizedEmail { get; set; }
        public string PasswordHash { get; set; }
        public string SecurityStamp { get; set; }
        public string ConcurrencyStamp { get; set; }
        public DateTime? LockoutEnd { get; set; }
        public bool LockoutEnabled { get; set; }
        public int AccessFailedCount { get; set; }
        public string Name { get; set; }
        public string GivenName { get; set; }
        public string PictureUrl { get; set; }
    }

    public static class PgRoutineFindUser
    {
        public const string Name = "find_user";

        /// <summary>
        /// sql function "find_user"
        /// find user record
        /// </summary>
        public static IEnumerable<User> FindUser(this NpgsqlConnection connection, long? id, string normalizedUserName, string normalizedEmail)
        {
            return connection
                .AsProcedure()
                .Read(Name, ("_id", id, NpgsqlDbType.Bigint), ("_normalized_user_name", normalizedUserName, NpgsqlDbType.Varchar), ("_normalized_email", normalizedEmail, NpgsqlDbType.Varchar))
                .Select<User>();
        }

        /// <summary>
        /// sql function "find_user"
        /// find user record
        /// </summary>
        public static IAsyncEnumerable<User> FindUserAsync(this NpgsqlConnection connection, long? id, string normalizedUserName, string normalizedEmail)
        {
            return  connection
                .AsProcedure()
                .ReadAsync(Name, ("_id", id, NpgsqlDbType.Bigint), ("_normalized_user_name", normalizedUserName, NpgsqlDbType.Varchar), ("_normalized_email", normalizedEmail, NpgsqlDbType.Varchar))
                .Select<User>();
        }
    }
}
```

